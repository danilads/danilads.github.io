<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>WebRTC LAN Chat</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; }
    textarea, input { width: 100%; margin: 5px 0; }
    textarea { height: 80px; }
    #chat { height: 200px; overflow-y: auto; background: #f0f0f0; padding: 10px; }
  </style>
</head>
<body>
  <h2>–ü—Ä–∏–º–µ—Ä –±–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫</h2>
  <h2>–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å QR</h2>
  <h2>WebRTC LAN –ß–∞—Ç (–±–µ–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤)</h2>
  <div>–£–°–¢–†–û–ô–°–¢–í–û 1 –°–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (Offer) + –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –∏–∑ –ø–æ–ª—è Offer (–ø–æ–ª–µ 1)  </div>
  <div>–£–°–¢–†–û–ô–°–¢–í–û 2 –í—Å—Ç–∞–≤–∏—Ç—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Offer –æ—Ç –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ 1 –≤ –ø–æ–ª–µ Offer 1!!!</div>
  <div>–£–°–¢–†–û–ô–°–¢–í–û 2 –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É 2 –í—Å—Ç–∞–≤–∏—Ç—å Offer + –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –∏–∑ –ø–æ–ª—è Offer (–ø–æ–ª–µ 2) </div>
  <div>–£–°–¢–†–û–ô–°–¢–í–û 1 –í—Å—Ç–∞–≤–∏—Ç—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Offer –æ—Ç –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ 2 –Ω–∞–∂–∞—Ç—å –ó–∞–≤–µ—Ä—à–∏—Ç—å</div>

  <button onclick="createOffer()">1. –°–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (Offer)</button>
  <textarea id="offer" placeholder="Offer –±—É–¥–µ—Ç –∑–¥–µ—Å—å"></textarea>

  <button onclick="receiveOffer()">2. –í—Å—Ç–∞–≤–∏—Ç—å Offer –∏ –æ—Ç–≤–µ—Ç–∏—Ç—å (Answer)</button>
  <textarea id="answer" placeholder="Answer –±—É–¥–µ—Ç –∑–¥–µ—Å—å"></textarea>

  <button onclick="receiveAnswer()">3. –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>

  <hr>
  <div id="chat"></div>
  <input id="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
  <button onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

  <script>
    let localConnection;
    let remoteConnection;
    let dataChannel;

    async function createOffer() {
      localConnection = new RTCPeerConnection();

      dataChannel = localConnection.createDataChannel("chat");
      setupDataChannel(dataChannel);

      const offer = await localConnection.createOffer();
      await localConnection.setLocalDescription(offer);

      localConnection.onicecandidate = e => {
        if (e.candidate === null) {
          document.getElementById("offer").value = JSON.stringify(localConnection.localDescription);
        }
      };
    }

    async function receiveOffer() {
      const offer = JSON.parse(document.getElementById("offer").value);

      remoteConnection = new RTCPeerConnection();

      remoteConnection.ondatachannel = event => {
        dataChannel = event.channel;
        setupDataChannel(dataChannel);
      };

      await remoteConnection.setRemoteDescription(offer);
      const answer = await remoteConnection.createAnswer();
      await remoteConnection.setLocalDescription(answer);

      remoteConnection.onicecandidate = e => {
        if (e.candidate === null) {
          document.getElementById("answer").value = JSON.stringify(remoteConnection.localDescription);
        }
      };
    }

    async function receiveAnswer() {
      const answer = JSON.parse(document.getElementById("answer").value);
      await localConnection.setRemoteDescription(answer);
    }

    function setupDataChannel(channel) {
      channel.onopen = () => log("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
      channel.onmessage = e => log("üë§ –î—Ä—É–≥: " + e.data);
      channel.onerror = e => log("‚ùå –û—à–∏–±–∫–∞: " + e);
    }

    function send() {
      const msg = document.getElementById("message").value;
      if (dataChannel && dataChannel.readyState === "open") {
        dataChannel.send(msg);
        log("üßë‚Äçüíª –í—ã: " + msg);
        document.getElementById("message").value = "";
      } else {
        log("‚ùó –ö–∞–Ω–∞–ª –Ω–µ –≥–æ—Ç–æ–≤");
      }
    }

    function log(text) {
      const chat = document.getElementById("chat");
      chat.innerHTML += text + "<br>";
      chat.scrollTop = chat.scrollHeight;
    }
  </script>
</body>
</html>
